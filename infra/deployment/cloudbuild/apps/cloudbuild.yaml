steps:
  # API
  - name: "gcr.io/cloud-builders/docker"
    id: api-docker-build
    args:
      - "build"
      - "--tag=${_API_IMAGE}"
      - "."
    dir: api
  - name: "gcr.io/cloud-builders/docker"
    id: api-docker-push
    args:
      - "push"
      - "${_API_IMAGE}"
  # apps
  - name: "hashicorp/terraform"
    id: terraform-apply-apps
    dir: infra/deployment/terraform/apps
    script: |
      terraform init -backend-config=bucket=$TFSTATE_BUCKET

      terraform apply --auto-approve
    env:
      - "TFSTATE_BUCKET=${_TFSTATE_BUCKET}"
      - "TF_VAR_org_id=${_ORG_ID}"
      - "TF_VAR_all_users_ingress_tag_value_id=${_ALL_USERS_INGRESS_TAG_VALUE_ID}"
      - "TF_VAR_project_id=${PROJECT_ID}"
      - "TF_VAR_region=${_REGION}"
      - "TF_VAR_public_kms_crypto_key=${_PUBLIC_KMS_CRYPTO_KEY}"
      - "TF_VAR_internal_kms_crypto_key=${_INTERNAL_KMS_CRYPTO_KEY}"
      - "TF_VAR_confidential_kms_crypto_key=${_CONFIDENTIAL_KMS_CRYPTO_KEY}"
      - "TF_VAR_restricted_kms_crypto_key=${_RESTRICTED_KMS_CRYPTO_KEY}"
      - "TF_VAR_api_image=${_API_IMAGE}"
      - "TF_VAR_api_sa_email=${_API_SA_EMAIL}"
      - "TF_VAR_api_domain_name=${_API_DOMAIN_NAME}"
      - "TF_VAR_monitoring_alerts_emails=${_MONITORING_ALERTS_EMAILS}"
      - "TF_VAR_oauth2_client_id=${_OAUTH2_CLIENT_ID}"
      - "TF_VAR_oauth2_client_secret_secret_id=${_OAUTH2_CLIENT_SECRET_SECRET_ID}"
options:
  logging: CLOUD_LOGGING_ONLY
